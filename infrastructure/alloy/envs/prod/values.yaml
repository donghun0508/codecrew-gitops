alloy:
  configMap:
    content: |-
      /*
        Unified Observability Configuration
        - Logs: Collect & Push to Loki (Cluster)
        - Metrics: Collect & Push to Remote Prometheus (MacBook)
      */

      logging {
        level  = "info"
        format = "logfmt"
      }

      discovery.kubernetes "pods" {
        role = "pod"
      }

      /* =========================
         LOGS PIPELINE
         ========================= */

      discovery.relabel "pod_logs" {
        targets = discovery.kubernetes.pods.targets

        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          action        = "replace"
          target_label  = "namespace"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          action        = "replace"
          target_label  = "pod"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          action        = "replace"
          target_label  = "container"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_label_app"]
          action        = "replace"
          target_label  = "app"
        }
      }

      loki.source.kubernetes "cluster" {
        targets    = discovery.relabel.pod_logs.output
        forward_to = [loki.process.spring_labels.receiver]
      }

      loki.process "spring_labels" {
        forward_to = [loki.write.grafana_loki.receiver]



        stage.multiline {
          firstline     = "^(?:\\[\\d{4}-\\d{2}-\\d{2}|\\d{4}-\\d{2}-\\d{2})"
          max_wait_time = "3s"
        }
      }

      loki.write "grafana_loki" {
        endpoint {
          url        = "http://loki-gateway.loki.svc.cluster.local/loki/api/v1/push"
          tenant_id  = "fake"
          batch_wait = "1s"
          batch_size = "1MB"
        }
      }

      /* =========================
         METRICS PIPELINE
         ========================= */

      discovery.relabel "pod_metrics" {
        targets = discovery.kubernetes.pods.targets

        // Only scrape pods with prometheus.io/scrape=true annotation
        rule {
          source_labels = ["__meta_kubernetes_pod_annotation_prometheus_io_scrape"]
          regex         = "true"
          action        = "keep"
        }

        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          action        = "replace"
          target_label  = "namespace"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          action        = "replace"
          target_label  = "pod"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_label_app"]
          action        = "replace"
          target_label  = "app"
        }
      }

      prometheus.scrape "default_scraper" {
        targets         = discovery.relabel.pod_metrics.output
        forward_to      = [prometheus.remote_write.macbook.receiver]
        scrape_interval = "15s"
        metrics_path    = "/actuator/prometheus"
      }

      prometheus.remote_write "macbook" {
        endpoint {
          url = "http://192.168.0.77:9090/api/v1/write"
        }
      }

controller:
  type: daemonset

resources:
  requests:
    cpu: 20m
    memory: 128Mi
  limits:
    cpu: 200m
    memory: 512Mi
